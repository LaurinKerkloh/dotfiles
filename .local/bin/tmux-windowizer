#!/bin/bash

set -e

# Select the directory to open in a (new) tmux session
if [[ $# -eq 1 ]]; then
  selected=$1
else
  selected=$(
      (
          echo $TMUX_SESSIONIZER_ROOT_DIRECTORY
          fd --type=directory . $TMUX_SESSIONIZER_ROOT_DIRECTORY
      ) | fzf --cycle
  )
fi

# Exit if no directory was selected
if [[ -z $selected ]]; then
  exit 0
fi

# Generate a window name based on the selected directory
if [[ $selected == "$HOME/code"* ]]; then
  window_name=$(echo $selected | sed -e "s|$HOME/code/||")
else
  window_name=$(basename $selected)
fi
window_name=$(echo $window_name | tr . _)

# (Create and) attach/switch to the window
window_id=$(tmux list-windows -F '#{window_name} #{window_id}' | awk "\$1==\"$window_name\" {print \$2}")
if [[ -n $window_id ]]; then
    tmux select-window -t $window_id
else
    tmux new-window -n $window_name -c $selected
fi
